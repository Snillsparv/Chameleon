<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelkv√§ll Trekamp!</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">

    <style>
        :root {
            --bg-overlay: rgba(15, 23, 42, 0.82);
            --card: rgba(30, 41, 59, 0.6);
            --primary: #818cf8;
            --accent: #d946ef;
            --accent2: #34d399;
            --winner-gold: #fbbf24;
            --text: #f8fafc;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            background-image: url('moln.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
            overflow-x: hidden;
        }

        .container {
            width: 95%;
            max-width: 820px;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            z-index: 2;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shimmer title */
        h1 {
            font-weight: 800;
            font-size: 2.4rem;
            margin-bottom: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--winner-gold), var(--accent2), var(--primary));
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 4s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subtitle { color: #94a3b8; margin-bottom: 20px; font-size: 1rem; }

        /* Progress indicator */
        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .progress-star {
            font-size: 1.6rem;
            opacity: 0.25;
            transition: all 0.4s ease;
            filter: grayscale(100%);
        }

        .progress-star.earned {
            opacity: 1;
            filter: grayscale(0%);
            animation: starPop 0.6s ease-out;
        }

        @keyframes starPop {
            0% { transform: scale(0.5) rotate(-20deg); }
            60% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Player strip */
        .player-strip {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0 14px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }

        .player-card {
            flex: 1 1 0;
            min-width: 0;
            text-align: center;
            position: relative;
            cursor: pointer;
        }

        .player-card .avatar-wrap {
            position: relative;
            display: inline-block;
        }

        .player-card .avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.15);
            display: block;
            max-width: 100%;
            transition: transform 0.3s ease;
        }

        .player-card:active .avatar {
            transform: scale(1.15) rotate(-5deg);
        }

        .player-card .medal {
            position: absolute;
            top: -6px;
            right: -2px;
            font-size: 1.3rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            z-index: 3;
        }

        .player-card .crown {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.4rem;
            z-index: 3;
            animation: crownBob 2s ease-in-out infinite;
        }

        @keyframes crownBob {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(-3deg); }
            50% { transform: translateX(-50%) translateY(-4px) rotate(3deg); }
        }

        .player-card .p-name {
            font-weight: 700;
            font-size: 0.82rem;
            color: var(--text);
            line-height: 1.2;
            margin-top: 6px;
        }

        .player-card .p-score {
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--primary);
            margin-top: 1px;
        }

        .player-card.leader .avatar {
            border-color: var(--winner-gold);
            box-shadow: 0 0 16px rgba(251, 191, 36, 0.5);
        }
        .player-card.leader .p-score { color: var(--winner-gold); }

        /* Wiggle animation on tap */
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg) scale(1.1); }
            50% { transform: rotate(8deg) scale(1.1); }
            75% { transform: rotate(-4deg); }
            100% { transform: rotate(0deg); }
        }

        .player-card.wiggle .avatar {
            animation: wiggle 0.5s ease;
        }

        /* Game cards */
        .game-cards { max-width: 500px; margin: 0 auto; }

        .game-card {
            background: var(--card);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 22px 20px;
            margin-bottom: 14px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 10px 25px -8px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            position: relative;
        }

        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -8px rgba(0,0,0,0.5);
            border-color: var(--primary);
        }

        .game-card .game-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
            display: inline-block;
            animation: iconBounce 3s ease-in-out infinite;
        }

        .game-card:nth-child(1) .game-icon { animation-delay: 0s; }
        .game-card:nth-child(2) .game-icon { animation-delay: 1s; }
        .game-card:nth-child(3) .game-icon { animation-delay: 2s; }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            15% { transform: translateY(-6px) rotate(-5deg); }
            30% { transform: translateY(0) rotate(0deg); }
        }

        .game-card .game-info { text-align: left; flex: 1; }
        .game-card .game-title { font-weight: 800; font-size: 1.2rem; color: var(--text); }
        .game-card .game-desc { color: #94a3b8; font-size: 0.82rem; line-height: 1.3; margin-top: 3px; }

        .game-card .check-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(52,211,153,0.5);
        }

        .game-card.played { opacity: 0.65; }
        .game-card.played:hover { opacity: 0.85; }

        /* Finish button */
        .btn-finish {
            background: linear-gradient(135deg, var(--winner-gold), #f59e0b);
            color: #1e293b;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            font-size: 1.15rem;
            margin-top: 14px;
            box-shadow: 0 10px 20px -5px rgba(251,191,36,0.4);
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        .btn-finish:hover { transform: translateY(-3px); box-shadow: 0 15px 30px -5px rgba(251,191,36,0.5); }

        .btn-reset {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            color: #64748b;
            padding: 12px;
            border-radius: 14px;
            font-size: 0.85rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-family: 'Outfit', sans-serif;
        }

        /* Finale screen */
        .hidden { display: none !important; }

        #scr-finale {
            background: var(--card);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 40px 25px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            max-width: 500px;
            margin: 0 auto;
        }

        .finale-winner-face {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--winner-gold);
            box-shadow: 0 0 30px rgba(251,191,36,0.5);
            animation: winnerBounce 1.5s ease-in-out infinite;
            margin: 0 auto 10px;
            display: block;
        }

        @keyframes winnerBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-12px) scale(1.05); }
        }

        .finale-crown { font-size: 4rem; margin-bottom: 5px; display: block; animation: crownSpin 2s ease-in-out infinite; }
        @keyframes crownSpin {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .finale-title {
            font-weight: 800; font-size: 2.2rem;
            color: var(--winner-gold);
            text-shadow: 0 0 20px rgba(251,191,36,0.4);
            margin-bottom: 5px;
        }

        .finale-subtitle { color: #94a3b8; margin-bottom: 25px; }

        .ranking-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.04);
            padding: 10px 14px;
            border-radius: 14px;
            margin-bottom: 8px;
        }

        .ranking-row .rank { font-weight: 800; font-size: 1.1rem; color: #64748b; min-width: 28px; }
        .ranking-row .rank.gold { color: var(--winner-gold); }
        .ranking-row .rank.silver { color: #cbd5e1; }
        .ranking-row .rank.bronze { color: #c9855a; }

        .ranking-row .r-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .ranking-row .r-name { flex: 1; text-align: left; font-weight: 600; }
        .ranking-row .r-score { font-weight: 800; color: var(--primary); }

        .btn-finale {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; padding: 16px; border-radius: 16px;
            font-weight: 700; cursor: pointer; width: 100%; font-size: 1.05rem;
            margin-top: 20px; font-family: 'Outfit', sans-serif;
        }

        /* Floating party emojis */
        .party-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .party-emoji {
            position: absolute;
            font-size: 1.8rem;
            opacity: 0;
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-10vh) rotate(360deg) scale(1); opacity: 0; }
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="party-bg" id="partyBg"></div>

<div class="container">

    <!-- HUB SCREEN -->
    <div id="scr-hub">
        <h1>Spelkv√§ll Trekamp!</h1>
        <p class="subtitle" id="subtitle">V√§lj ett spel och k√§mpa om segern!</p>

        <div class="progress-bar" id="progressBar"></div>

        <div class="player-strip" id="playerGrid"></div>

        <div class="game-cards">
            <a href="kameleonten.html" class="game-card" id="gc-kameleonten">
                <span class="game-icon">ü¶é</span>
                <div class="game-info">
                    <div class="game-title">Kameleonten</div>
                    <div class="game-desc">Bluffa dig genom 100 kategorier!</div>
                </div>
            </a>

            <a href="herd-mentality.html" class="game-card" id="gc-herd">
                <span class="game-icon">üêÆ</span>
                <div class="game-info">
                    <div class="game-title">Herd Mentality</div>
                    <div class="game-desc">T√§nk som flocken!</div>
                </div>
            </a>

            <a href="med-andra-ord.html" class="game-card" id="gc-mao">
                <span class="game-icon">üí¨</span>
                <div class="game-info">
                    <div class="game-title">Med andra ord</div>
                    <div class="game-desc">F√∂rklara ord utan att s√§ga dem!</div>
                </div>
            </a>

            <button class="btn-finish" onclick="showFinale()">Avsluta spelkv√§llen!</button>
            <button class="btn-reset" onclick="resetAll()">Nollst√§ll allt och b√∂rja om</button>
        </div>
    </div>

    <!-- FINALE SCREEN -->
    <div id="scr-finale" class="hidden">
        <span class="finale-crown">üëë</span>
        <img id="finaleWinnerFace" class="finale-winner-face" src="" alt="Vinnare">
        <div class="finale-title" id="finaleWinnerName">Vinnare!</div>
        <p class="finale-subtitle" id="finaleWinnerSub">vinner spelkv√§llen!</p>
        <div id="finaleRanking"></div>
        <button class="btn-finale" onclick="resetAll()">Ny spelkv√§ll!</button>
    </div>

</div>

<div class="confetti-container" id="confettiContainer"></div>

<script src="shared.js"></script>
<script>
    const GAME_KEYS = [
        { key: 'kameleonten', game: 'kameleonten', icon: 'ü¶é' },
        { key: 'herd', game: 'herd-mentality', icon: 'üêÆ' },
        { key: 'mao', game: 'med-andra-ord', icon: 'üí¨' }
    ];

    const FUN_SUBTITLES = [
        'V√§lj ett spel och k√§mpa om segern!',
        'Vem blir kv√§llens m√§stare?',
        'Dags att visa vem som √§r b√§st!',
        'Redo att spela? Let\'s gooo!'
    ];

    const PROGRESS_SUBTITLES = [
        null,
        'Bra start! Tv√• spel kvar!',
        'Bara ett spel kvar!',
        'Alla spel avklarade! Dags f√∂r finalen?'
    ];

    function getScores() {
        try { return JSON.parse(localStorage.getItem('trekamp_scores') || '{}'); }
        catch { return {}; }
    }

    function getGamesPlayed() {
        try { return JSON.parse(localStorage.getItem('trekamp_games') || '[]'); }
        catch { return []; }
    }

    function renderHub() {
        const scores = getScores();
        const games = getGamesPlayed();
        const grid = document.getElementById('playerGrid');

        // Sorted by score for medal assignment
        const withScores = PLAYERS.map(p => ({ ...p, score: scores[p.name] || 0 }));
        const sorted = [...withScores].sort((a, b) => b.score - a.score);

        // Assign medals: only if score > 0
        const medals = {};
        const medalEmojis = ['ü•á', 'ü•à', 'ü•â'];
        let prevScore = -1;
        let rank = 0;
        sorted.forEach((p, i) => {
            if (p.score <= 0) return;
            if (p.score !== prevScore) rank = i;
            if (rank < 3) medals[p.name] = medalEmojis[rank];
            prevScore = p.score;
        });

        const maxScore = sorted[0]?.score || 0;

        grid.innerHTML = PLAYERS.map(p => {
            const s = scores[p.name] || 0;
            const isLeader = s > 0 && s === maxScore;
            const mood = isLeader ? 'Glad' : 'Rund';
            const medal = medals[p.name] || '';
            const crown = isLeader ? '<span class="crown">üëë</span>' : '';

            return `<div class="player-card${isLeader ? ' leader' : ''}" onclick="wigglePlayer(this)">
                <div class="avatar-wrap">
                    ${crown}
                    <img class="avatar" src="${getImg(p, mood)}" alt="${p.name}">
                    ${medal ? '<span class="medal">' + medal + '</span>' : ''}
                </div>
                <div class="p-name">${p.name}</div>
                <div class="p-score">${s} p</div>
            </div>`;
        }).join('');

        // Progress stars
        const progressBar = document.getElementById('progressBar');
        progressBar.innerHTML = GAME_KEYS.map(g => {
            const played = games.includes(g.game);
            return `<span class="progress-star ${played ? 'earned' : ''}">${played ? '‚≠ê' : '‚òÜ'}</span>`;
        }).join('');

        // Dynamic subtitle
        const numPlayed = games.length;
        const sub = PROGRESS_SUBTITLES[numPlayed] ||
            FUN_SUBTITLES[Math.floor(Math.random() * FUN_SUBTITLES.length)];
        document.getElementById('subtitle').textContent = sub;

        // Mark played games with star badge
        GAME_KEYS.forEach(({ key, game }) => {
            const card = document.getElementById('gc-' + key);
            const badge = card.querySelector('.check-badge');
            if (badge) badge.remove();
            if (games.includes(game)) {
                card.classList.add('played');
                card.insertAdjacentHTML('beforeend', '<div class="check-badge">‚≠ê</div>');
            } else {
                card.classList.remove('played');
            }
        });
    }

    function wigglePlayer(el) {
        el.classList.remove('wiggle');
        void el.offsetWidth;
        el.classList.add('wiggle');
        setTimeout(() => el.classList.remove('wiggle'), 600);
    }

    // Floating party emojis
    function startPartyBackground() {
        const container = document.getElementById('partyBg');
        const emojis = ['üéà', 'üéâ', '‚≠ê', 'üéä', '‚ú®', 'üé™', 'üéØ', 'üèÜ', 'üé∂', 'üéµ'];
        function spawnEmoji() {
            const el = document.createElement('span');
            el.className = 'party-emoji';
            el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            el.style.left = (Math.random() * 100) + '%';
            el.style.fontSize = (1.2 + Math.random() * 1.2) + 'rem';
            el.style.animationDuration = (8 + Math.random() * 12) + 's';
            el.style.animationDelay = '0s';
            container.appendChild(el);
            const duration = parseFloat(el.style.animationDuration) * 1000;
            setTimeout(() => el.remove(), duration);
        }
        // Spawn a batch immediately for a "full" feeling
        for (let i = 0; i < 8; i++) {
            setTimeout(spawnEmoji, i * 400);
        }
        setInterval(spawnEmoji, 2500);
    }

    // Welcome-back confetti if new scores detected
    function checkWelcomeBack() {
        const lastScores = sessionStorage.getItem('trekamp_last_scores');
        const currentScores = JSON.stringify(getScores());
        if (lastScores && lastScores !== currentScores && currentScores !== '{}') {
            setTimeout(() => launchConfetti(40), 500);
        }
        sessionStorage.setItem('trekamp_last_scores', currentScores);
    }

    function showFinale() {
        document.getElementById('scr-hub').classList.add('hidden');
        document.getElementById('scr-finale').classList.remove('hidden');

        const scores = getScores();
        const sorted = PLAYERS.map(p => ({ ...p, score: scores[p.name] || 0 }))
            .sort((a, b) => b.score - a.score);

        const winner = sorted[0];
        document.getElementById('finaleWinnerFace').src = getImg(winner, 'Glad');
        document.getElementById('finaleWinnerName').textContent = winner.name;
        document.getElementById('finaleWinnerSub').textContent = `vinner spelkv√§llen med ${winner.score} po√§ng!`;

        const rankColors = ['gold', 'silver', 'bronze'];
        const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
        const ranking = document.getElementById('finaleRanking');
        ranking.innerHTML = sorted.map((p, i) => {
            const mood = i === 0 ? 'Glad' : (i >= sorted.length - 2 ? 'Ledsen' : 'Rund');
            return `<div class="ranking-row">
                <span class="rank ${rankColors[i] || ''}">${rankEmojis[i] || (i + 1) + '.'}</span>
                <img class="r-avatar" src="${getImg(p, mood)}" alt="${p.name}">
                <span class="r-name">${p.name}</span>
                <span class="r-score">${p.score} p</span>
            </div>`;
        }).join('');

        playSound('fanfar');
        launchConfetti(80);
    }

    function resetAll() {
        if (confirm('Vill du verkligen nollst√§lla allt och b√∂rja en ny spelkv√§ll?')) {
            localStorage.removeItem('trekamp_scores');
            localStorage.removeItem('trekamp_games');
            sessionStorage.removeItem('trekamp_last_scores');
            location.reload();
        }
    }

    renderHub();
    startPartyBackground();
    checkWelcomeBack();
</script>
</body>
</html>
